services:
  - type: web
    name: servicioshogar-backend
    env: node
    plan: free
    branch: main
    buildCommand: |
      echo "=== Render Build Process ==="
      echo "Working directory: $(pwd)"
      echo "Contents: $(ls -la)"
      
      # Build frontend
      echo "=== Building Frontend ==="
      cd frontend
      echo "Frontend directory: $(pwd)"
      npm ci
      npm run build
      echo "Frontend build complete. Checking dist..."
      ls -la dist/ || echo "No dist directory found"
      cd ..
      
      # Build backend
      echo "=== Building Backend ==="
      cd backend
      echo "Backend directory: $(pwd)"
      npm ci
      npm run build
      
      # Copy frontend files with enhanced verification
      echo "=== Copying Frontend Files ==="
      echo "Creating frontend-dist directory..."
      mkdir -p frontend-dist
      echo "Checking source directory..."
      ls -la ../frontend/dist/ || echo "Source directory not found"
      echo "Copying files..."
      cp -r ../frontend/dist/* ./frontend-dist/ 2>&1 || echo "Copy command failed"
      echo "Checking destination..."
      ls -la frontend-dist/ || echo "Destination directory not found"
      
      # Enhanced verification
      if [ ! -f "./frontend-dist/index.html" ]; then
        echo "ERROR: Frontend copy verification failed"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Frontend dist source:"
        ls -la ../frontend/dist/ || echo "Source not found"
        echo "Frontend dist destination:"
        ls -la frontend-dist/ || echo "Destination not found"
        exit 1
      fi
      
      echo "=== Build Completed Successfully ==="
      echo "Final verification:"
      ls -la frontend-dist/
      echo "Frontend files copied: $(ls frontend-dist/ | wc -l) files"
    startCommand: cd backend && npm start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false
      - key: PORT
        value: 10000
      - key: VAPID_PUBLIC_KEY
        sync: false
      - key: VAPID_PRIVATE_KEY
        sync: false
      - key: VAPID_EMAIL
        sync: false
      - key: SESSION_SECRET
        sync: false

