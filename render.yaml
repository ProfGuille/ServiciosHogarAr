services:
  - type: web
    name: servicioshogar-backend
    env: node
    plan: free
    branch: main
    buildCommand: |
      set -e  # Exit on any error
      
      echo "=== Render Build Process ==="
      BASE_DIR="$(pwd)"
      echo "Base directory: $BASE_DIR"
      echo "Contents: $(ls -la)"
      
      # Build frontend first
      echo "=== Building Frontend ==="
      cd "$BASE_DIR/frontend"
      echo "Frontend directory: $(pwd)"
      npm ci
      npm run build
      echo "Frontend build complete. Checking dist..."
      ls -la dist/ || echo "No dist directory found"
      
      # Build backend  
      echo "=== Building Backend ==="
      cd "$BASE_DIR/backend"
      echo "Backend directory: $(pwd)"
      npm ci
      npm run build
      
      # Copy frontend files to the backend directory for deployment
      echo "=== Copying Frontend Files for Deployment ==="
      FRONTEND_DIST_SRC="$BASE_DIR/frontend/dist"
      BACKEND_DIST_DST="$BASE_DIR/backend/frontend-dist"
      
      echo "Source path: $FRONTEND_DIST_SRC"
      echo "Destination path: $BACKEND_DIST_DST"
      
      # Ensure backend directory exists
      mkdir -p "$BACKEND_DIST_DST"
      
      echo "Checking source directory..."
      if [ ! -d "$FRONTEND_DIST_SRC" ]; then
        echo "ERROR: Source directory does not exist: $FRONTEND_DIST_SRC"
        exit 1
      fi
      
      echo "Source directory contents:"
      ls -la "$FRONTEND_DIST_SRC"
      
      echo "Copying files..."
      # Copy all files from frontend/dist to backend/frontend-dist
      cp -r "$FRONTEND_DIST_SRC"/* "$BACKEND_DIST_DST/" 2>&1
      # Also copy hidden files if they exist
      cp -r "$FRONTEND_DIST_SRC"/.[!.]* "$BACKEND_DIST_DST/" 2>/dev/null || echo "No hidden files to copy"
      
      echo "Checking destination after copy..."
      ls -la "$BACKEND_DIST_DST"
      
      # Enhanced verification
      if [ ! -f "$BACKEND_DIST_DST/index.html" ]; then
        echo "ERROR: Frontend copy verification failed - index.html not found"
        echo "Destination directory contents:"
        ls -la "$BACKEND_DIST_DST" || echo "Destination directory doesn't exist"
        exit 1
      fi
      
      # Create deployment diagnostic file
      echo "=== Creating Deployment Diagnostic ==="
      cat > "$BASE_DIR/backend/deployment-diagnostic.json" << EOF
      {
        "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
        "build_directory": "$BASE_DIR",
        "frontend_source": "$FRONTEND_DIST_SRC",
        "frontend_destination": "$BACKEND_DIST_DST",
        "frontend_files_count": $(find "$BACKEND_DIST_DST" -type f 2>/dev/null | wc -l),
        "index_exists": $(test -f "$BACKEND_DIST_DST/index.html" && echo "true" || echo "false"),
        "backend_dist_exists": $(test -d "$BASE_DIR/backend/dist" && echo "true" || echo "false")
      }
      EOF
      
      echo "=== Final Verification ==="
      echo "Backend directory contents:"
      ls -la "$BASE_DIR/backend/"
      echo "Frontend-dist contents:"
      ls -la "$BACKEND_DIST_DST/" || echo "frontend-dist directory not found"
      
      echo "=== Build Completed Successfully ==="
      echo "Frontend files copied: $(find "$BACKEND_DIST_DST" -type f 2>/dev/null | wc -l) files"
    startCommand: cd backend && npm start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false
      - key: PORT
        value: 10000
      - key: VAPID_PUBLIC_KEY
        sync: false
      - key: VAPID_PRIVATE_KEY
        sync: false
      - key: VAPID_EMAIL
        sync: false
      - key: SESSION_SECRET
        sync: false

